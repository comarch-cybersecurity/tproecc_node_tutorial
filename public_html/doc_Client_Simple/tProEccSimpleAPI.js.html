<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: tProEccSimpleAPI.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: tProEccSimpleAPI.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
	* @file Simplified Web Browser API, which provides methods to interact with tPro Ecc token in order to:
	* &lt;br> - initialize the device,
	* &lt;br> - create digital signature of delivered content,
	* &lt;br> - change PIN,
	* &lt;br> - obtaining detailed information about token's state.
*/

/** @class 
	* @classdesc Methods, which this class provides, are dedicated for communicating with tPro Ecc in order to perform cryptographic operations. It is dedicated to be used in any custom web application.
*/
function TProEccSimpleAPI() {
    this.PIN_APP_REPLACE_STRING = "3131313100";
    this.KEY_APP_REPLACE_STRING = "3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333300";
    this.HASH_APP_REPLACE_STRING = "343434343434343434343434343434343434343434343434343434343434343400";
    this.OLD_PIN_APP_REPLACE_STRING = "3535353500";
    this.NEW_PIN_APP_REPLACE_STRING = "3636363600";                                                                                                                                
    this.SIGN_APP="C6C74E412BEFBD3AB5FFD399702CD233B41CB9873F6BCA668171EB7695C0F3AECC126A3C3943336651A5F678523D6292722C4BB1D4DBF23E193934ABC4111E270028002600C8020300FE01FE03FE040000000401040000052006080180081F800A00000096641000268631313131003434343434343434343434343434343434343434343434343434343434343434000A0202020202";
    this.GET_TOKEN_INFO_APP = "98FB80E5466D18A5E5009B4BAD656C7C0DFFF1F06705F6EA2B22B258D7843C16825BF6F340760D230AC3C6B772B540B834FDEDA3230B784CC5A65B7CBD73BE13001200100000020200FE01FE081C800A00008001";
    this.INIT_APP = "71363A818DD877F643EC0CAC2AF63C526B4916C5F668E818408A30713EC90205D50C5FE158B8508849AEA5D5793883E950FD6C57F927F94A57C7859839FF68C4002E002C0000020200FE01FE040000000401040000050809080180080B80081E800A000000966411000D866400000000313131310044656661756C740002020202020A";
    this.UNBLOCK_PIN_APP = "4C60BF0855696788DAE959B38C36349F5E7838732D7607E9E1129B9305CEEB296D260E7687A29FE3AC442F51B011C16353AB462079964E28C58B16B293FFF66A0030002E00C8020300FE01FE03FE0400000008010400000904030801800804800803800A0000009664010000006410000E8232323232323232320031313131000505";
    this.CHANGE_PIN_APP = "C6E8E2585D8E74ECAE16F0E1EB14E93DBA53B6FCCF96FAB48EE0C191C4FE0E803504698DD84848C1820DCF4C26C29FCC11AF3F16FBC89DA7F14CA9D4F02E54080030002E00C8020300FE01FE03FE0400000004010400000504030801800804800809800A0000009664000000006411000A82353535350036363636000505";
	var communication = require("./helpers/ws.js");
	this.c = new communication();
	var utils = require("./helpers/functions.js");
	this.u = new utils();
	var err = require("./helpers/errorCodes.js");
	this.e = new err();
}
/**
 * Return information about the token.
 * @function getTokenInfo
 * @param {getTokenInfoCallback} cb - The callback that handles the response.
 *
 * @example
 * //return {"init":true,"keyc":1,"pinmin":4,"pinmax":4,"pin":3,"puk":-1,"sn":"0123039C10588732EE","fw":"1.0.35","pub":"0485de6a646383d5aebb96089663ad244ad88a9d0fea8427c814dea8afd1e0db66e67d666b285456435228b5f7282546f922fbd036232a0de5e9943a5960610d4b","pop":{"pd":"0000000123039c10588732ee3a5e4a52de4ddc9e4014d9f39330e2a784be82183621b217c81e769f8eb9ef3f","sgn":"304402205fc08cf710dc3a0fb6293946641795d1a0ef048ee65734b1f92549e0f3795ded022023df93d3bbf63fd9c6c9f3c34cdaff8dcab40a386e0d5236c2753ccdad5ef85c0000"}}
 * var TProEccSimpleAPIInstance = new TProEccSimpleAPI();
 * TProEccSimpleAPIInstance.getTokenInfo(param, function(errorCode, data) {
 *   if(errorCode === EXIT_CODE_ACCEPT) alert (JSON.stringify(data); else alert( "error:"+errorCode)
 * });
 */
/**
 * @callback getTokenInfoCallback
 * @param {number}  error - status of operation, null means success
 * @param {Object}  data - information about token
 * @param {boolean} data.init - token is initalized (true/false)
 * @param {number}  data.pin - pin tries left
 * @param {number}  data.puk - puk tries left, 0xff mean puk not set
 * @param {number}  data.pinmin - min pin lenght
 * @param {number}  data.pinmax - max pin lenght
 * @param {string}  data.sn - token serial number
 * @param {string}  data.fw - firmware version
 * @param {string}  data.pub - hex representation of the public key
 * @param {Object}  data.pop - POP (proof of possesion) data
 * @param {string}  data.pop.pd - hex representation of  POP data
 * @param {string}  data.pop.sdn - hex representation of POP signature
 *
 */
TProEccSimpleAPI.prototype.getTokenInfo = function(callback)
{
	var app = this.GET_TOKEN_INFO_APP;
    this.c.doConnect(app, callback);
}
 /*
 * Wait for token insertion and return information about the token.
 * @function getTokenInfo
 * @param {Number} timeout - timeout
 * @param {getTokenInfoCallback} cb - The callback that handles the response.
 *
 * @example
 * return {"init":true,"keyc":1,"pinmin":4,"pinmax":4,"pin":3,"puk":-1,"sn":"0123039C10588732EE","fw":"1.0.35","pub":"0485de6a646383d5aebb96089663ad244ad88a9d0fea8427c814dea8afd1e0db66e67d666b285456435228b5f7282546f922fbd036232a0de5e9943a5960610d4b","pop":{"pd":"0000000123039c10588732ee3a5e4a52de4ddc9e4014d9f39330e2a784be82183621b217c81e769f8eb9ef3f","sgn":"304402205fc08cf710dc3a0fb6293946641795d1a0ef048ee65734b1f92549e0f3795ded022023df93d3bbf63fd9c6c9f3c34cdaff8dcab40a386e0d5236c2753ccdad5ef85c0000"}}
 * var TProEccSimpleAPIInstance = new TProEccSimpleAPI();
 * TProEccSimpleAPIInstance.getTokenInfo(10, function(errorCode, data) {
 *   if(errorCode === EXIT_CODE_ACCEPT) alert (JSON.stringify(data); else alert( "error:"+errorCode)
 * });
 */
/*
 * @callback getTokenInfoCallback
 * @param {number}  error - status of operation, null means success
 * @param {Object}  data - information about token
 * @param {boolean} data.init - token is initalized (true/false)
 * @param {number}  data.pin - pin tries left
 * @param {number}  data.puk - puk tries left, 0xff mean puk not set
 * @param {number}  data.pinmin - min pin lenght
 * @param {number}  data.pinmax - max pin lenght
 * @param {string}  data.sn - token serial number
 * @param {string}  data.fw - firmware version
 * @param {string}  data.pub - hex representation of the public key
 * @param {Object}  data.pop - POP (proof of possesion) data
 * @param {string}  data.pop.pd - hex representation of  POP data
 * @param {string}  data.pop.sdn - hex representation of POP signature
 *
*/
TProEccSimpleAPI.prototype.getTokenInfo = function(timeout, callback, ref)
{
	var tmp;
	if( ref !== undefined ) {
		tmp = ref;
	} else {
		tmp = this;
		timeout = timeout;
	}
	var app = tmp.GET_TOKEN_INFO_APP;
    tmp.c.doConnect(app, function(error, data){
		if(error !== null &amp;&amp; error.err === tmp.e.EXIT_CODE_CONNECTION_ERROR &amp;&amp; timeout > 0 ) {
			setTimeout( tmp.getTokenInfoT, 2000, timeout-1, callback, tmp );
		} else {
			callback(error, data);
		}
	} );
};
/**
 * Set PIN and generate key-pair.
 * @function init
 * @param {string}  param - pin provided by user
 * @param {initCallback} cb - The callback that handles the response.
 *
 * @example
 * //returns {"init":true,"keyc":1,"pinmin":4,"pinmax":4,"pin":2,"puk":-1,"sn":"012362B86F619F5DEE","fw":"1.0.35","pub":"04aa3264070822eac747ee63d00ee9547e8e773775ca8fe3a3ce8624caff23bf0f94a3048490e65ff5e5b994904286a0b66e075d55f300f5f2d19fdbb1743f0884","pop":{"pd":"000000012362b86f619f5dee6055e78f8c6719951fa69cbdb1704faa802d288f85ec68780f991b338dcd2f3b","sgn":"304602210099aa2d1f941049c08afa375e018468285ed79b33c13830f2ab597a250f717268022100bc97a0aa23234259a89081504086d5af1474b00ec1436156c4a5631e9b91db74"}}
 * var api = require('TProEccSimpleAPI');
 * var TProEccAPI = new api();
 * TProEccAPI.init(pin, function(err, data) {
 *   if(err === null) alert (JSON.stringify(data); else alert( "error:"+err.desc+" ("+err.err+")");
 * });
 */
/**
 * @callback initCallback
 * @param {number}  error - status of operation, null means success
 * @param {Object}  data - output
 * @param {string}  data.pub - hex representation of the public key
 * @param {Object}  data.pop - POP (proof of possesion) data
 * @param {string}  data.pop.pd - hex representation of  POP data
 * @param {string}  data.pop.sdn - hex representation of POP signature
 */
TProEccSimpleAPI.prototype.init = function(param, callback) 
{
    var app = this.INIT_APP;
    var pinHex = this.u.stringToHex(param);
    app = this.u.replaceRes(app, this.PIN_APP_REPLACE_STRING, pinHex );
    this.c.doConnect(app, callback);
};
/**
 * Sign input with SHA256 digest.
 * @function sign
 * @param {Object}  param - input parameters
 * @param {string}  param.pin - pin provided by user
 * @param {string}  param.dgst - hex representation of SHA256 digest
 * @param {signCallback} cb - The callback that handles the response.
 *
 * @example
 * //returns {"sgn":"304502203625b6685f1c62b36787580f0cf0d600e4a4643472a79ec749d3925c9d473e9f02210080ab73adf8c8529d9bfe53f6336ba83d173fd8936581e67d9557355c428ea57a00"}
 * var api = require('TProEccSimpleAPI');
 * var TProEccAPI = new api();
 * var param = {};
 * param.pin = pin;
 * param.hash = hash;
 * TProEccAPI.getTokenInfo(param, function(err, data) {
 *   if(err === null) alert (JSON.stringify(data); else alert( "error:"+err.desc+" ("+err.err+")");
 * });
 */
/**
 * @callback signCallback
 * @param {number}  error - status of operation, null means success
 * @param {Object}  data - output
 * @param {string}  data.sgn - hex representation of the signature
 */
TProEccSimpleAPI.prototype.sign = function(param, callback) 
{
	var app = this.SIGN_APP;
    var pinHex = this.u.stringToHex(param.pin);
    var hashHex = param.dgst;
    app = this.u.replaceRes( app,  this.HASH_APP_REPLACE_STRING, hashHex );
    app = this.u.replaceRes( app,  this.PIN_APP_REPLACE_STRING, pinHex );
    this.c.doConnect(app, callback);
};
/**
 * Change user PIN.
 * @function changePin
 * @param {Object}  param - input parameters
 * @param {string}  param.oldpin - actual pin
 * @param {string}  param.newpin - new pin to set
 * @param {changePinCallback} cb - The callback that handles the response.
 *
 * @example
 * var api = require('TProEccSimpleAPI');
 * var TProEccAPI = new api();
 * var param = {};
 * param.oldPin = $('#oldpin').val();
 * param.newPin = $('#newpin').val();
 * TProEccAPI.changePin(param, function(err, data) {
 *   if(err === null) alert (JSON.stringify(data); else alert( "error:"+err.desc+" ("+err.err+")");
 * });
 */
/**
 * @callback changePinCallback
 * @param {number}  error - status of operation, null means success
 */
TProEccSimpleAPI.prototype.changePin = function(param, callback) 
{
    var app = this.CHANGE_PIN_APP;
    var oldPinHex = this.u.stringToHex(param.oldPin);
    var newPinHex = this.u.stringToHex(param.newPin);
    app = this.u.replaceRes( app,  this.OLD_PIN_APP_REPLACE_STRING, oldPinHex );
    app = this.u.replaceRes( app,  this.NEW_PIN_APP_REPLACE_STRING, newPinHex );
    this.c.doConnect(app, callback);
};
/**
 * Calculate SHA256 digest.
 * @function dgst
 * @param {string}  msg - message
 * @return hex representation of SHA256 digest
 *
 * @example
 * var api = require('TProEccSimpleAPI');
 * var TProEccAPI = new api();
 * var dgst = TProEccAPI.dgst(msg);
 */
TProEccSimpleAPI.prototype.dgst = function(msg) {
	var createHash = require('sha.js');
	var sha256 = createHash('sha256');
	return sha256.update(msg).digest('hex');
};

/** TProEccSimpleAPI */
module.exports = TProEccSimpleAPI;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="errorCodes.html">errorCodes</a></li><li><a href="TProEccSimpleAPI.html">TProEccSimpleAPI</a></li></ul><h3>Global</h3><ul><li><a href="global.html#changePin">changePin</a></li><li><a href="global.html#dgst">dgst</a></li><li><a href="global.html#getTokenInfo">getTokenInfo</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#sign">sign</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Fri Jan 27 2017 11:03:26 GMT+0100 (Åšrodkowoeuropejski czas stand.)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
